<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Attendance Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container">
    <h1>ðŸ“Š Attendance Dashboard</h1>
    <canvas id="attendanceChart" class="chart-container"></canvas>

    <h2>Student Attendance Records</h2>
    <table id="dataTable" border="1" style="border-collapse: collapse; width:100%; text-align:center;">
      <thead>
        <tr><th>Student ID</th><th>Course ID</th><th>Status</th><th>Time</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <button onclick="loadData()">Refresh Data</button>
  </div>

  <script>
    const funcBase = "http://127.0.0.1:5010/cc-lab-project-attendance/us-central1/api";

    async function loadData() {
      try {
        const res = await fetch(funcBase + "/getAttendance");
        const data = await res.json();

        const total = data.length;
        const present = data.filter(a => a.status === "present").length;
        const absent = total - present;

        renderChart(present, absent);
        renderTable(data);
      } catch (err) {
        console.error("Error loading data:", err);
        alert("Failed to fetch data.");
      }
    }

    let chart;
    function renderChart(present, absent) {
      const ctx = document.getElementById("attendanceChart").getContext("2d");
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: "pie",
        data: {
          labels: ["Present", "Absent"],
          datasets: [{
            data: [present, absent],
            backgroundColor: ["#22c55e", "#ef4444"]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: { display: true, text: "Overall Attendance Summary" },
            legend: { position: "bottom" }
          }
        }
      });
    }

    function renderTable(data) {
      const tbody = document.querySelector("#dataTable tbody");
      tbody.innerHTML = "";
      data.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.studentId}</td>
          <td>${r.courseId}</td>
          <td style="color:${r.status === 'present' ? 'green' : 'red'}">${r.status}</td>
          <td>${new Date(r.timestamp).toLocaleString()}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    loadData();
  </script>
</body>
</html>
